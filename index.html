<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8" />
        <title>Notes</title>
        <link rel="shortcut icon" href="/res/img/logo.ico" />
        <link rel="stylesheet" href="/res/css/main.css" />
        <script type="text/javascript" src="/res/js/jquery-1.7.2.min.js"></script>
        <script type="text/javascript" src="/res/js/jquery-ui-1.8.17.custom.min.js"></script>
        <script type="text/javascript" src="/res/js/jquery.loadmask.min.js"></script>
        <script type="text/javascript" src="/res/js/knockout-2.1.0.js"></script>
        <script type="text/javascript" src="/res/js/model.noteslist.js"></script>
        <script type="text/javascript">
            function rndId() {
                var S4 = function() {
                    return (((1 + Math.random()) * 0x10000) | 0).toString(16).substring(1);
                };
                return (S4() + S4() + "-" + S4() + "-" + S4() + "-" + S4() + "-" + S4() + S4() + S4());
            };
        </script>
        <script>
            function NotesApp() {
                var self = this;

                self.rootNote     = null;
                self.listView     = null;
                self.deletedNotes = ko.observableArray([]);
                
                self.init = function() {
                    // Create the root note and initialise bindings
                    self.rootNote = new NoteModel({content:"Home"});
                    self.listView = new NotesListViewModel(self.rootNote)
                    ko.applyBindings(self, document.getElementById("content"));
                    
                    // Load notes from the server
                    $("#root").mask("Loading notes...", 300);
                    $.getJSON("/note", function(data){
                        self.rootNote.loadSubnotes(data);
                        $("#root").unmask();
                        if (self.rootNote.hasSubnotes()) {
                            self.rootNote.subnotes()[0].startEdit();
                        }
                    })
                    .error(function(res) {
                        alert("Error occured while loading notes from the server.")
                    });
                    
                    // Setup global keyboard shortcuts
                    $('body').on('keydown', function(event){
                        if (event.which==107) {
                            self.rootNote.addSubnote().startEdit();
                            return false;
                        }
                        return true;
                    });
                };
                
                self.undo = function() {
                    if (self.deletedNotes().length > 0) {
                        var note = self.deletedNotes.pop();
                        //restore the note
                        note.parent().addSubnote(note, {position: note.position()});
                    }
                };
            };
            
            var app = new NotesApp();
            $(document).ready(function() {
                app.init();
            });
        </script>
        <!-- NOTES TEMPLATE -->
        <script type="text/html" id="note-template">
            <div class="note" data-bind="attr: {id: id}, css: {closed: !isOpen()}">
            <a href="javascript:void(0)" class="open-link" data-bind="visible: hasSubnotes() && !isZoomedIn(), click: toggleOpen, text: isOpen() ? '-' : '+'">+</a><a href="#" class="zoom-in-link" data-bind="attr: {href: hash}, click: app.listView.zoomIn, css: {saving: isUpdateScheduled}">â€¢</a>
            <!-- ko ifnot: isZoomedIn -->
                <div class="drop-target above"></div>
            <!-- /ko -->
            <div class="editor" style="position:relative">
            <div class="drag-handler" title="Drag to reorder">&nbsp;</div>
            <div class="content" data-bind="text: content, event: {click: startEdit}, style: {visibility: isInEdit() ? 'hidden' : 'visible'}"></div>
            <textarea class="content" placeholder="Just start typing" data-bind="visible: isInEdit, text: content, value: content, valueUpdate: 'afterkeydown', hasfocus: isInEdit, event: {keydown: onUserInput}"></textarea>
            </div>
            <!-- ko ifnot: isZoomedIn -->
            <div class="drop-target below"></div>
            <!-- /ko -->
            <div class="sub-notes" data-bind="template: {name: 'note-template', foreach: subnotes, afterRender: function(elements, data) {setTimeout(function(){app.listView._setupDragDrop(elements,data);},1000)}}"></div>
            </div>
        </script>
        <!-- END OF NOTES TEMPLATE -->
        <!-- BREADCRUMBS TEMPLATE -->
        <script type="text/html" id="breadcrumbs-template">
            <!--ko if: parent -->
            <span data-bind="template: {name: 'breadcrumbs-template', data: parent}"></span>
            <!-- /ko -->
            <!-- ko if: $data == app.listView.rootNote() -->
            <div class="nav" data-bind="attr: {href:hash, title:content}, css: {nav: parent}, text: content, click: app.listView.zoomIn"></div>
            <!-- /ko -->
            <!-- ko ifnot: $data == app.listView.rootNote() -->
            <a href="#" class="nav" data-bind="attr: {href:hash, title:content}, css: {nav: parent}, text: content, click: app.listView.zoomIn"></a>
            <!-- /ko -->
        </script>
        <!-- END OF BREADCRUMBS TEMPLATE -->
    </head>
    <body>
        <div id="content">
            <div id="main-menu">
                <span style="float:left;" class="title">Notes</span>
                <div style="float:right;margin-right: 10px;line-height: 28px;">
                    <a href="javascript:void(0)" data-bind="click: undo, css: {disabled: deletedNotes().length <= 0}">Undo</a>
                    <a href="javascript:void(0)">Save</a>
                </div>
            </div>
            <div id="breadcrumbs" data-bind="template: {name: 'breadcrumbs-template', data: app.listView.rootNote}">
            </div>
            <div id="root">
                <h2 data-bind="text:app.listView.rootNote().content"></h2>
                <div id="subnotes" data-bind="template: {name: 'note-template', foreach: app.listView.rootNote().subnotes, afterRender: function(elements, data) {setTimeout(function(){app.listView._setupDragDrop(elements,data);},1000)}}"></div>
                <a id="add-note" href="javascript:void(0)" title="Add new note" data-bind="click: function(){app.listView.rootNote().addSubnote().startEdit();}">+</a>
            </div>
        </div>
        <div id="footer">
            &copy; Ilia Frenkel, 2012.&nbsp;|&nbsp;Build using Google App Engine.&nbsp;|&nbsp;<a href="/_ah/admin/">Admin</a>
        </div>
    </body>
</html>
